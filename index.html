<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="style.css" />
    <!-- <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet" /> -->


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Data Portal</title>
</head>

<body>
    <div class="sidebar open">
        <div class="logo-details">
            <i class="bx bxl-c-plus-plus icon"></i>
            <a href="home.html" class="logo_name">Data Portal</a>
            <svg id="btn" viewBox="0 0 40 40" width="20" height="22" fill="#fff">
                <rect width="40" height="8" rx="4"></rect>
                <rect y="15" width="40" height="8" rx="4"></rect>
                <rect y="30" width="40" height="8" rx="4"></rect>
            </svg>
        </div>

        <h3 class="nav-header">Filters</h3>
        <hr>
        <ul class="nav-list">
            <li>
                <label class="form-label" for="provinceSelect">Province</label>
                <select id="provinceSelect" name="provinceSelect">
                    <option value="">Select a province</option>
                    <option value="បន្ទាយមានជ័យ">បន្ទាយមានជ័យ</option>
                    <option value="បាត់ដំបង">បាត់ដំបង</option>
                    <option value="កំពង់ចាម">កំពង់ចាម</option>
                    <option value="កំពង់់ឆ្នាំង">កំពង់់ឆ្នាំង</option>
                    <option value="កំពង់ស្ពឺ">កំពង់ស្ពឺ</option>
                    <option value="កំពង់ធំ">កំពង់ធំ</option>
                    <option value="កំពត">កំពត</option>
                    <option value="កណ្តាល">កណ្តាល</option>
                    <option value="កោះកុង">កោះកុង</option>
                    <option value="ក្រចេះ">ក្រចេះ</option>
                    <option value="មណ្ឌលគិរី">មណ្ឌលគិរី</option>
                    <option value="ភ្នំពេញ">ភ្នំពេញ</option>
                    <option value="ព្រះវិហារ">ព្រះវិហារ</option>
                    <option value="ព្រៃវែង">ព្រៃវែង</option>
                    <option value="ពោធិ៍សាត់">ពោធិ៍សាត់</option>
                    <option value="រតនគិរី">រតនគិរី</option>
                    <option value="សៀមរាប">សៀមរាប</option>
                    <option value="ព្រះសីហនុ">ព្រះសីហនុ</option>
                    <option value="ស្ទឹងត្រែង">ស្ទឹងត្រែង</option>
                    <option value="ស្វាយរៀង">ស្វាយរៀង</option>
                    <option value="តាកែវ">តាកែវ</option>
                    <option value="ឧត្តរមានជ័យ">ឧត្តរមានជ័យ</option>
                    <option value="កែប">កែប</option>
                    <option value="ប៉ៃលិន">ប៉ៃលិន</option>
                    <option value="ត្បូងឃ្មុំ">ត្បូងឃ្មុំ</option>
                </select>
            </li>
            <!-- <li>
                <label class="form-label">Date Range</label>
                <div class="form-inline-wrapper">
                    <input placeholder="Start Date" class="form-input__date" type="text" id="startDate" />
                    <input placeholder="End Date" class="form-input__date" type="text" id="endDate" />
                </div>
            </li> -->
        </ul>

        <h3 class="nav-header">Navigation</h3>
        <hr>
        <ul class="nav-list">
            <li>
                <a href="home.html">Home</a>
            </li>
            <li>
                <a href="#">Report (In Progress)</a>
            </li>
        </ul>
    </div>
    <section id="map" class="home-section">
    </section>

    <!-- <script src="https://cdn.jsdelivr.net/npm/leaflet-wms-header@1.0.13/index.min.js"></script> -->

    <script>
        function getQueryParam(key) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(key);
        }

        let map = L.map('map', {
            center: [12.5657, 104.991],
            zoom: 7
        });

        let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const BASE_MAP = { "Open Street Map": osm }
        const OVERLAY_MAP = {}

        const server = getQueryParam('map') || 'cfi';
        const geoServer = `https://staging.fia.db.opendevcam.net/geoserver/${server}/wms`;

        function handleJson(data, key) {
            const styleHashMap = {
                'CFI_A': {
                    radius: 4,
                    fillColor: "#ff7800",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                },
                'CFI_B': {
                    color: "black",
                    fillColor: "orange",
                    weight: 1,
                    fillOpacity: 0.5,
                    opacity: 0.5,
                },
                // 'CFR_A': {
                //     radius: 4,
                //     fillColor: "#ff7800",
                //     color: "#000",
                //     weight: 1,
                //     opacity: 1,
                //     fillOpacity: 0.8
                // }
                CFR_A: (feature) => {
                    switch (feature.properties.is_qualified_cfr) {
                        case 'បាទ/ចាស៎': return {color: "green", radius: 4, weight: 1, opacity: 1, fillOpacity: 0.8};
                        case 'ទេ': return {color: "red", radius: 4, weight: 1, opacity: 1, fillOpacity: 0.8};
                        default: return {color: "blue", radius: 4, weight: 1, opacity: 1, fillOpacity: 0.8}
                    }
                }
            }

            const featureHandler = {
                'CFI_A': function (feature, layer) {
                    layer.bindPopup(
                        '<li>' + `Community: ${feature.properties.cfi_name}` + '</li>' +
                        '<li>' + `FiAC Score: ${feature.properties.fiac_score}` + '</li>' +
                        '<li>' + `Province: ${feature.properties.province}` + '</li>'
                    )
                },
                'CFI_B': function (feature, layer) {
                    layer.bindPopup(
                        '<li>' + `CFI Name (EN): ${feature.properties.name_en}` + '</li>' +
                        '<li>' + `CFI Name (KM): ${feature.properties.name}` + '</li>' +
                        '<li>' + `Area (Ha): ${feature.properties.area_ha}` + '</li>' +
                        '<li>' + `Province: ${feature.properties.province}` + '</li>' +
                        '<li>' + `Type: ${feature.properties.type}` + '</li>' +
                        '<li>' + `Created on: ${feature.properties.creation_date}` + '</li>' +
                        '<li>' + `Registered on: ${feature.properties.registration_date}` + '</li>'
                    )
                },
                'CFR_A': function (feature, layer) {
                    layer.bindPopup(
                        '<li>' + `Community: ${feature.properties.cfr_name}` + '</li>' +
                        '<li>' + `Province: ${feature.properties.province}` + '</li>' +
                        '<li>' + `Type: ${feature.properties.cfr_type}` + '</li>' +
                        '<li>' + `Qualified?: ${feature.properties.is_qualified_cfr}` + '</li>'
                    )
                }
            }

            OVERLAY_MAP[key] = L.geoJson(data, {
                style: styleHashMap[key],
                pointToLayer: function (feature, latlng) {
                    var circleMarker = L.circleMarker(latlng, styleHashMap[key]);
                    return(circleMarker);
                },
                onEachFeature: featureHandler[key],
            });
            map.flyToBounds(OVERLAY_MAP[key].getBounds());

            // IMPORTANT MAKE THIS DYNAMIC
            const len = Object.keys(OVERLAY_MAP).length;
            const shouldAddLayer = (server === 'cfi' && len === 2) || (server === 'cfr' && len === 1);

            if (shouldAddLayer) {
                L.control.layers(BASE_MAP, OVERLAY_MAP).addTo(map);
                OVERLAY_MAP[key].addTo(map);
            }
        }

        L.control.scale().addTo(map);

        function handleJsonCFI_B(data) {
            handleJson(data, 'CFI_B')
        }

        function handleJsonCFI_A(data) {
            handleJson(data, 'CFI_A')
        }

        function handleJsonCFR_A(data) {
            handleJson(data, 'CFR_A')
        }

        function getAjax(key,) {
            const PARAM = {
                CFI_A: {
                    typename: 'cfi:Effectiveness_Assessment_2022',
                    callback: 'callback:handleJsonCFI_A'
                },
                CFI_B: {
                    typename: 'cfi:cfi',
                    callback: 'callback:handleJsonCFI_B'
                },
                CFR_A: {
                    typename: 'cfr:cfr_wf_assessment_2022',
                    callback: 'callback:handleJsonCFR_A'
                }
            };

            const CQL = getQueryParam('province') ? `province = '${getQueryParam('province')}'` : '';

            $.ajax(geoServer, {
                type: 'GET',
                async: false,
                data: {
                    service: 'WFS',
                    version: '1.1.0',
                    request: 'GetFeature',
                    typename: PARAM[key].typename,
                    CQL_FILTER: CQL,
                    srsname: 'EPSG:4326',
                    outputFormat: 'text/javascript',
                },
                dataType: 'jsonp',
                jsonpCallback: PARAM[key].callback,
                jsonp: 'format_options'
            });
        }

        // MAIN 
        $(document).ready(function () {
            if (server === 'cfi') {
                // CFI assessment
                getAjax('CFI_A');

                // CFI Boundary
                getAjax('CFI_B');

            } else if (server === 'cfr') {
                //CFR Assessment
                getAjax('CFR_A');
            }

            document.getElementById('provinceSelect').addEventListener('change', function (e) {
                const val = e.currentTarget.value;

                const searchParams = new URLSearchParams(window.location.search);
                searchParams.set("province", e.currentTarget.value);

                window.location.href = 'index.html?' + searchParams.toString();
            });

            if (getQueryParam('province')) {
                $('#provinceSelect').val(getQueryParam('province'))
            }
        })

        // document.addEventListener('DOMContentLoaded', function () {
        //     function isEmpty(obj) {
        //         return Object.keys(obj).length === 0;
        //     }

        //     function updateFilter(obj, key, val) {
        //         obj[key] = val;

        //         return Object.values(obj).filter(x => x).join(' AND ');
        //     }

        //     (function filter() {
        //         let cql_filter = {};
        //         const LAYER_KEY = 'CFR Status Assessment 2022';

        //         document.getElementById('provinceSelect').addEventListener('change', function (e) {
        //             const val = e.currentTarget.value;
        //             const param = val ? `province = '${e.currentTarget.value}'` : '';

        //             wmsLayers[LAYER_KEY].setParams({ CQL_FILTER: updateFilter(cql_filter, 'province', param) });
        //         });

        //         document.getElementById('startDate').addEventListener('change', function (e) {
        //             const val = e.currentTarget.value;
        //             const param = val ? `today AFTER ${new Date(val).toISOString()}` : '';

        //             wmsLayers[LAYER_KEY].setParams({ CQL_FILTER: updateFilter(cql_filter, 'startDate', param) });
        //         });

        //         document.getElementById('endDate').addEventListener('change', function (e) {
        //             const val = e.currentTarget.value;
        //             const param = val ? `today BEFORE ${new Date(val).toISOString()}` : '';

        //             wmsLayers[LAYER_KEY].setParams({ CQL_FILTER: updateFilter(cql_filter, 'endDate', param) });
        //         });


        //     })();

        //     document.querySelectorAll('.form-input__date').forEach((element) => {
        //         function showDate(e) {
        //             e.currentTarget.type = 'date';
        //             e.currentTarget.showPicker();
        //         }

        //         element.addEventListener('focus', showDate);
        //         element.addEventListener('click', showDate);
        //         element.addEventListener('change', function (e) {

        //         });
        //     });

        //     (function initMenu() {
        //         let sidebar = document.querySelector(".sidebar");
        //         let closeBtn = document.querySelector("#btn");
        //         let searchBtn = document.querySelector(".bx-search");

        //         closeBtn.addEventListener("click", () => {
        //             sidebar.classList.toggle("open");
        //             menuBtnChange();//calling the function(optional)
        //         });

        //         // following are the code to change sidebar button(optional)
        //         function menuBtnChange() {
        //             if (sidebar.classList.contains("open")) {
        //                 closeBtn.classList.replace("bx-menu", "bx-menu-alt-right");//replacing the iocns class
        //             } else {
        //                 closeBtn.classList.replace("bx-menu-alt-right", "bx-menu");//replacing the iocns class
        //             }
        //         }
        //     })();
        // });
    </script>
</body>

</html>